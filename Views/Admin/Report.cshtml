@{
    ViewBag.Title = "Admin Report";
}
<!-- Floating Download Button -->
<button id="downloadBtn" class="btn btn-success position-fixed shadow-sm rounded-circle p-2" style="top: 10px; right: 10px; z-index: 1000;">
    <i class="fas fa-download"></i>
</button>

<!-- Admin Report Title -->
<h3 class="text-center text-primary fw-bold mb-3">Admin Report</h3>

<div class="container">
    <div class="text-end mb-2">
        <a href="@Url.Action("TotalUsers", "Admin")" class="btn btn-sm btn-primary shadow-sm">
            <i class="fas fa-users"></i> View Total Users Report
        </a>
    </div>

    <div class="row g-2">
        <!-- Users Card -->
        <div class="col-md-4 col-6">
            <a href="@Url.Action("ManageUsers", "Admin")" class="text-decoration-none">
                <div class="card text-center shadow-sm border-0 rounded-3 p-2" style="background: linear-gradient(135deg, #6E85B7, #B2C8DF);">
                    <i class="fas fa-users fa-2x text-white"></i>
                    <h6 class="text-white mt-1">Users</h6>
                    <h5 class="text-white fw-bold">@ViewBag.UsersCount</h5>
                </div>
            </a>
        </div>

        <!-- Properties Card -->
        <div class="col-md-4 col-6">
            <a href="@Url.Action("TotalProperties", "Admin")" class="text-decoration-none">
                <div class="card text-center shadow-sm border-0 rounded-3 p-2" style="background: linear-gradient(135deg, #FFA500, #FFC107);">
                    <i class="fas fa-home fa-2x text-white"></i>
                    <h6 class="text-white mt-1">Properties</h6>
                    <h5 class="text-white fw-bold">@ViewBag.PropertiesCount</h5>
                </div>
            </a>
        </div>

        <!-- Pending Approvals -->
        <div class="col-md-4 col-6">
            <a href="@Url.Action("PendingProperties", "Admin")" class="text-decoration-none">
                <div class="card text-center shadow-sm border-0 rounded-3 p-2" style="background: linear-gradient(135deg, #DC3545, #FF6B6B);">
                    <i class="fas fa-exclamation-circle fa-2x text-white"></i>
                    <h6 class="text-white mt-1">Pending</h6>
                    <h5 class="text-white fw-bold">@ViewBag.PendingApprovals</h5>
                </div>
            </a>
        </div>

        <!-- Pending Approvals -->
        <div class="col-md-4 col-6">
            <div class="col-md-6 col-12">
                <canvas id="pieChart" class="shadow-sm rounded-3"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mt-3">
        <div class="col-md-6 col-12">
            <canvas id="barChart" class="shadow-sm rounded-3"></canvas>
        </div>
        
    </div>

    <!-- Top Users Table -->
    <div class="mt-4">
        <h6 class="text-primary fw-bold">Top Users (Most Properties Posted)</h6>
        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
            <table class="table table-sm table-striped table-hover shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Properties</th>
                    </tr>
                </thead>
                <tbody id="topUsersTable">
                    @foreach (var user in ViewBag.TopUsers)
                    {
                        <tr>
                            <td>@user.UserId</td>
                            <td>@user.Name</td>
                            <td>@user.PropertyCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Bar Chart
        var ctx1 = document.getElementById('barChart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: ['Users', 'Properties', 'Pending'],
                datasets: [{
                    label: 'Stats',
                    data: [@ViewBag.UsersCount, @ViewBag.PropertiesCount, @ViewBag.PendingApprovals],
                    backgroundColor: ['#4A90E2', '#FF9800', '#FF3D00'],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                animation: { duration: 1200 }
            }
        });

        // Pie Chart
        var ctx2 = document.getElementById('pieChart').getContext('2d');
        new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Approved', 'Pending'],
                datasets: [{
                    data: [@ViewBag.ApprovedProperties, @ViewBag.PendingProperties],
                    backgroundColor: ['#28A745', '#FFC107']
                }]
            },
            options: {
                responsive: true,
                animation: { duration: 1500 }
            }
        });

        // CSV Download
        document.getElementById("downloadBtn").addEventListener("click", function () {
            let csvContent = "User ID,Name,Properties\n";

            document.querySelectorAll("#topUsersTable tr").forEach(row => {
                let columns = row.querySelectorAll("td");
                if (columns.length > 0) {
                    csvContent += columns[0].innerText + "," + columns[1].innerText + "," + columns[2].innerText + "\n";
                }
            });

            let blob = new Blob([csvContent], { type: "text/csv" });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "TopUsersReport.csv";
            link.click();
        });
    });
</script>
